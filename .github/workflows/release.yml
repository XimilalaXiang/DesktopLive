name: Build and Release

on:
  push:
    tags:
      - 'v*'

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ç”Ÿæˆ changelog
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install root dependencies
        run: npm install
      
      - name: Install frontend dependencies
        run: npm install
        working-directory: ./frontend
      
      - name: Install server dependencies
        run: npm install
        working-directory: ./server
      
      - name: Build and Package
        # ä½¿ç”¨ --publish never ç¦ç”¨ electron-builder çš„è‡ªåŠ¨å‘å¸ƒ
        run: npm run build && npx electron-builder --win --publish never
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "## DeLive ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“¥ ä¸‹è½½ / Downloads" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "| æ–‡ä»¶ / File | è¯´æ˜Ž / Description |" >> $GITHUB_OUTPUT
          echo "|-------------|---------------------|" >> $GITHUB_OUTPUT
          echo "| \`DeLive-${{ steps.get_version.outputs.VERSION }}-x64.exe\` | Windows å®‰è£…åŒ… / Windows Installer |" >> $GITHUB_OUTPUT
          echo "| \`DeLive-${{ steps.get_version.outputs.VERSION }}-portable.exe\` | ä¾¿æºç‰ˆï¼ˆæ— éœ€å®‰è£…ï¼‰/ Portable Version |" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ”„ æ›´æ–°å†…å®¹ / What's Changed" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "è¯·æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/commits/v${{ steps.get_version.outputs.VERSION }})" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“– ä½¿ç”¨è¯´æ˜Ž / Usage" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "1. ä¸‹è½½ä¸Šæ–¹çš„å®‰è£…åŒ…æˆ–ä¾¿æºç‰ˆ" >> $GITHUB_OUTPUT
          echo "2. è¿è¡Œå®‰è£…æˆ–ç›´æŽ¥æ‰“å¼€ä¾¿æºç‰ˆ" >> $GITHUB_OUTPUT
          echo "3. åœ¨è®¾ç½®ä¸­é…ç½® ASR æœåŠ¡å•†çš„ API å¯†é’¥" >> $GITHUB_OUTPUT
          echo "4. å¼€å§‹å½•åˆ¶å¹¶äº«å—å®žæ—¶è½¬å½•ï¼" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: DeLive v${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: false
          prerelease: false
          files: |
            release/*.exe
            release/*.exe.blockmap
            release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
